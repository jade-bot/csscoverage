#!/usr/bin/env node

var fs = require('fs');
var path = require('path');

var program = require('commander');

//console.log(process.argv);
program
	.version('0.0.3')
  .usage('[options] [urls]')
	.option('-c, --config <file>', 'Config File')
  .option('-s, --server', 'Start Web Server')
  .option('-p, --port <8000>', 'Web Server Port', '8000');

program.parse(process.argv);

var print = function(coverage) {
  for (var file in coverage.stylesheets) {
    var ss = coverage.stylesheets[file];
    console.log(file);
    console.log('-------------------------------------');
    for (var i = 0, c = ss.selectors.length; i < c; i++) {
      var selector = ss.selectors[i];
      if (selector.misses.length === 0)
        continue;
      console.log('\t' + selector.text);
      console.log('\t-------------------------------------');
      console.log("\t\tHits: " + selector.hits.join(', '));
      console.log("\t\tMisses: " + selector.misses.join(', '));
      console.log("");
    }
  }
};

var run = function(urls) {
  var coverage = require('../lib/coverage');
  coverage(urls, function(coverage) {
    print(coverage);
  });
};

if (program.config) {
  var urls = [];
  fs.readFile(program.config, 'utf8', function(err, data) {
    if (err) {
      console.log(program.config + ' doesn\'t exist');
      return;
    }

    var config = JSON.parse(data);
    var baseUrl = config.baseUrl || '';
    config.urls.forEach(function(url) {
      urls.push(baseUrl + url);
    });
    run(urls);
  });

} else if (program.server) {
  var app = require('../lib/server'); 
  app.listen(program.port, "0.0.0.0");
} else if (program.args) {
  var urls = program.args;
  run(urls);
} else {
  console.log("Please pass in url(s)");
}
